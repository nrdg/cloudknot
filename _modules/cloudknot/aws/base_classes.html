
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cloudknot.aws.base_classes &#8212; cloudknot 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/collapsible.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">cloudknot</a></h1>



<p class="blurb">Run your existing python code on AWS Batch</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=richford&repo=cloudknot&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">faq</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/tree/master/examples">examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot">code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/issues">bugs</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cloudknot.aws.base_classes</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">botocore</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">..config</span> <span class="k">import</span> <span class="n">get_config_file</span><span class="p">,</span> <span class="n">rlock</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;clients&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fn</span>


<span class="n">mod_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">get_ecr_repo</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the cloudknot ECR repository</span>

<span class="sd">    First, check the cloudknot config file for the ecr-repo option.</span>
<span class="sd">    If that fails, check for the CLOUDKNOT_ECR_REPO environment variable.</span>
<span class="sd">    If that fails, use &#39;cloudknot&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    repo : string</span>
<span class="sd">        Cloudknot ECR repository name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;ecr-repo&#39;</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set `repo`, the fallback repo in case the cloudknot</span>
            <span class="c1"># repo environment variable is not set</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get the region from an environment variable</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CLOUDKNOT_ECR_REPO&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="s1">&#39;cloudknot&#39;</span>

        <span class="c1"># Use set_ecr_repo to check for name availability</span>
        <span class="c1"># and write to config file</span>
        <span class="n">set_ecr_repo</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">repo</span>


<span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">set_ecr_repo</span><span class="p">(</span><span class="n">repo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the cloudknot ECR repo</span>

<span class="sd">    Set repo by modifying the cloudknot config file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    repo : string</span>
<span class="sd">        Cloudknot ECR repo name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Update the config file</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">):</span>  <span class="c1"># pragma: nocover</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;ecr-repo&#39;</span><span class="p">,</span> <span class="n">repo</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If repo exists, retrieve its info</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_repositories</span><span class="p">(</span>
                <span class="n">repositoryNames</span><span class="o">=</span><span class="p">[</span><span class="n">repo</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RepositoryNotFoundException</span><span class="p">:</span>
            <span class="c1"># If it doesn&#39;t exists already, then create it</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_repository</span><span class="p">(</span><span class="n">repositoryName</span><span class="o">=</span><span class="n">repo</span><span class="p">)</span>


<div class="viewcode-block" id="get_s3_params"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.get_s3_params.html#cloudknot.aws.get_s3_params">[docs]</a><span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">get_s3_params</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the cloudknot S3 bucket and corresponding access policy</span>

<span class="sd">    For the bucket name, first check the cloudknot config file for the bucket</span>
<span class="sd">    option. If that fails, check for the CLOUDKNOT_S3_BUCKET environment</span>
<span class="sd">    variable. If that fails, use</span>
<span class="sd">    &#39;cloudknot-&#39; + get_user().lower() + &#39;-&#39; + uuid4()</span>

<span class="sd">    For the policy name, first check the cloudknot config file. If that fails,</span>
<span class="sd">    use &#39;cloudknot-bucket-access-&#39; + str(uuid.uuid4())</span>

<span class="sd">    For the region, first check the cloudknot config file. If that fails,</span>
<span class="sd">    use the current cloudknot region</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bucket : NamedTuple</span>
<span class="sd">        A namedtuple with fields [&#39;bucket&#39;, &#39;policy&#39;, &#39;policy_arn&#39;, &#39;sse&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="n">BucketInfo</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;BucketInfo&#39;</span><span class="p">,</span>
                            <span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">,</span> <span class="s1">&#39;policy&#39;</span><span class="p">,</span> <span class="s1">&#39;policy_arn&#39;</span><span class="p">,</span> <span class="s1">&#39;sse&#39;</span><span class="p">])</span>

    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;s3-bucket-policy&#39;</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
            <span class="c1"># Get policy name from the config file</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># or set policy to None to create it in the call to</span>
            <span class="c1"># set_s3_params()</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;s3-bucket&#39;</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get the bucket name from an environment variable</span>
                <span class="n">bucket</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CLOUDKNOT_S3_BUCKET&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># Use the fallback bucket b/c the cloudknot</span>
                <span class="c1"># bucket environment variable is not set</span>
                <span class="n">bucket</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;cloudknot-&#39;</span> <span class="o">+</span> <span class="n">get_user</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                          <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># In this case, the bucket name is new, but the policy is not.</span>
                <span class="c1"># Update the policy to reflect the new bucket name.</span>
                <span class="n">update_s3_policy</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>

        <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;s3-sse&#39;</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
            <span class="n">sse</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sse</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AES256&#39;</span><span class="p">,</span> <span class="s1">&#39;aws:kms&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                    <span class="s1">&#39;The server-side encryption option &quot;sse&quot; must must be &#39;</span>
                    <span class="s1">&#39;one of [&quot;AES256&quot;, &quot;aws:kms&quot;, &quot;None&quot;]&#39;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sse</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">sse</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">sse</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Use set_s3_params to check for name availability</span>
        <span class="c1"># and write to config file</span>
        <span class="n">set_s3_params</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span> <span class="n">sse</span><span class="o">=</span><span class="n">sse</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;s3-bucket-policy&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">list_policies</span><span class="p">(</span><span class="n">Scope</span><span class="o">=</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span>
                                            <span class="n">PathPrefix</span><span class="o">=</span><span class="s1">&#39;/cloudknot/&#39;</span><span class="p">)</span>
    <span class="n">policy_arn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;PolicyName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">policy</span><span class="p">,</span>
        <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Policies&#39;</span><span class="p">)</span>
    <span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Arn&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">BucketInfo</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span>
                      <span class="n">policy_arn</span><span class="o">=</span><span class="n">policy_arn</span><span class="p">,</span> <span class="n">sse</span><span class="o">=</span><span class="n">sse</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_s3_params"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.set_s3_params.html#cloudknot.aws.set_s3_params">[docs]</a><span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">set_s3_params</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sse</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the cloudknot S3 bucket</span>

<span class="sd">    Set bucket by modifying the cloudknot config file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bucket : string</span>
<span class="sd">        Cloudknot S3 bucket name</span>
<span class="sd">    policy : string</span>
<span class="sd">        Cloudknot S3 bucket access policy name</span>
<span class="sd">        Default: None means that cloudknot will create a new policy</span>
<span class="sd">    sse : string</span>
<span class="sd">        S3 server side encryption method. If provided, must be one of</span>
<span class="sd">        [&#39;AES256&#39;, &#39;aws:kms&#39;].</span>
<span class="sd">        Default: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sse</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AES256&#39;</span><span class="p">,</span> <span class="s1">&#39;aws:kms&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;The server-side encryption option &quot;sse&quot; &#39;</span>
                                  <span class="s1">&#39;must be one of [&quot;AES256&quot;, &quot;aws:kms&quot;]&#39;</span><span class="p">)</span>

    <span class="c1"># Update the config file</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_bucket_put_get</span><span class="p">(</span><span class="n">bucket_</span><span class="p">,</span> <span class="n">sse_</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;cloudnot-test-permissions-key&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sse_</span><span class="p">:</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_</span><span class="p">,</span> <span class="n">Body</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                         <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">ServerSideEncryption</span><span class="o">=</span><span class="n">sse_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_</span><span class="p">,</span> <span class="n">Body</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;The requested bucket name already &#39;</span>
                                      <span class="s1">&#39;exists and you do not have permission &#39;</span>
                                      <span class="s1">&#39;to put or get objects in it.&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">):</span>  <span class="c1"># pragma: nocover</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;s3-bucket&#39;</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>

        <span class="c1"># Create the bucket</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_region</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">:</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span>
                    <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span>
                    <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
                    <span class="n">CreateBucketConfiguration</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;LocationConstraint&#39;</span><span class="p">:</span> <span class="n">get_region</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BucketAlreadyOwnedByYou</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BucketAlreadyExists</span><span class="p">:</span>
            <span class="n">test_bucket_put_get</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">sse</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Check for Illegal Location Constraint</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">error_code</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;IllegalLocationConstraintException&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;InvalidLocationConstraint&#39;</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_bucket_location</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LocationConstraint&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s1">&#39;us-east-1&#39;</span> <span class="ow">or</span> <span class="n">location</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span>
                            <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
                            <span class="n">CreateBucketConfiguration</span><span class="o">=</span><span class="p">{</span>
                                <span class="s1">&#39;LocationConstraint&#39;</span><span class="p">:</span> <span class="n">location</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BucketAlreadyOwnedByYou</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BucketAlreadyExists</span><span class="p">:</span>
                    <span class="n">test_bucket_put_get</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">sse</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Pass exception to user</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="s1">&#39;cloudknot-bucket-access-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create the policy</span>
            <span class="n">s3_policy_doc</span> <span class="o">=</span> <span class="n">bucket_policy_document</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>

            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_policy</span><span class="p">(</span>
                <span class="n">PolicyName</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span>
                <span class="n">Path</span><span class="o">=</span><span class="s1">&#39;/cloudknot/&#39;</span><span class="p">,</span>
                <span class="n">PolicyDocument</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">s3_policy_doc</span><span class="p">),</span>
                <span class="n">Description</span><span class="o">=</span><span class="s1">&#39;Grants access to S3 bucket </span><span class="si">{0:s}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EntityAlreadyExistsException</span><span class="p">:</span>
            <span class="c1"># Policy already exists, do nothing</span>
            <span class="k">pass</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;s3-bucket-policy&#39;</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;s3-sse&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sse</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">bucket_policy_document</span><span class="p">(</span><span class="n">bucket</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the policy document to access an S3 bucket</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bucket: string</span>
<span class="sd">        An Amazon S3 bucket name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s3_policy_doc: dict</span>
<span class="sd">        A dictionary containing the AWS policy document</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add policy statements to access to cloudknot S3 bucket</span>
    <span class="n">s3_policy_doc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;s3:ListBucket&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;arn:aws:s3:::</span><span class="si">{0:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket</span><span class="p">)]</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;s3:PutObject&quot;</span><span class="p">,</span> <span class="s2">&quot;s3:GetObject&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;arn:aws:s3:::</span><span class="si">{0:s}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket</span><span class="p">)]</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">s3_policy_doc</span>


<span class="k">def</span> <span class="nf">update_s3_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">bucket</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the cloudknot S3 access policy with new bucket name</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    policy: string</span>
<span class="sd">        Amazon S3 bucket access policy name</span>

<span class="sd">    bucket: string</span>
<span class="sd">        Amazon S3 bucket name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s3_policy_doc</span> <span class="o">=</span> <span class="n">bucket_policy_document</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>

    <span class="c1"># Get the ARN of the policy</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">list_policies</span><span class="p">(</span>
        <span class="n">Scope</span><span class="o">=</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span>
        <span class="n">PathPrefix</span><span class="o">=</span><span class="s1">&#39;/cloudknot/&#39;</span>
    <span class="p">)</span>

    <span class="n">policy_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Policies&#39;</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;PolicyName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">policy</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">arn</span> <span class="o">=</span> <span class="n">policy_dict</span><span class="p">[</span><span class="s1">&#39;Arn&#39;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Update the policy</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_policy_version</span><span class="p">(</span>
                <span class="n">PolicyArn</span><span class="o">=</span><span class="n">arn</span><span class="p">,</span>
                <span class="n">PolicyDocument</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">s3_policy_doc</span><span class="p">),</span>
                <span class="n">SetAsDefault</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">LimitExceededException</span><span class="p">:</span>
            <span class="c1"># Too many policy versions. List policy versions and delete oldest</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">list_policy_versions</span><span class="p">(</span>
                <span class="n">PolicyArn</span><span class="o">=</span><span class="n">arn</span>
            <span class="p">)</span>

            <span class="c1"># Get non-default versions</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Versions&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;IsDefaultVersion&#39;</span><span class="p">]]</span>

            <span class="c1"># Get the oldest version and delete it</span>
            <span class="n">oldest</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">versions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ver</span><span class="p">:</span> <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;CreateDate&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_policy_version</span><span class="p">(</span>
                <span class="n">PolicyArn</span><span class="o">=</span><span class="n">arn</span><span class="p">,</span>
                <span class="n">VersionId</span><span class="o">=</span><span class="n">oldest</span><span class="p">[</span><span class="s1">&#39;VersionId&#39;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Update the policy not that there&#39;s room for another version</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_policy_version</span><span class="p">(</span>
                <span class="n">PolicyArn</span><span class="o">=</span><span class="n">arn</span><span class="p">,</span>
                <span class="n">PolicyDocument</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">s3_policy_doc</span><span class="p">),</span>
                <span class="n">SetAsDefault</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>


<div class="viewcode-block" id="get_region"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.get_region.html#cloudknot.aws.get_region">[docs]</a><span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">get_region</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the default AWS region</span>

<span class="sd">    First, check the cloudknot config file for the region option.</span>
<span class="sd">    If that fails, check for the AWS_DEFAULT_REGION environment variable.</span>
<span class="sd">    If that fails, use the region in the AWS (not cloudknot) config file.</span>
<span class="sd">    If that fails, use us-east-1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    region : string</span>
<span class="sd">        default AWS region</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set `region`, the fallback region in case the cloudknot</span>
            <span class="c1"># config file has no region set</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get the region from an environment variable</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_DEFAULT_REGION&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># Get the default region from the AWS config file</span>
                <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
                <span class="n">aws_config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s1">&#39;.aws&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>

                <span class="n">fallback_region</span> <span class="o">=</span> <span class="s1">&#39;us-east-1&#39;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">aws_config_file</span><span class="p">):</span>
                    <span class="n">aws_config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
                    <span class="n">aws_config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">aws_config_file</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">region</span> <span class="o">=</span> <span class="n">aws_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="n">fallback_region</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                        <span class="c1"># python 2.7 compatibility</span>
                        <span class="n">region</span> <span class="o">=</span> <span class="n">aws_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">)</span>
                        <span class="n">region</span> <span class="o">=</span> <span class="n">region</span> <span class="k">if</span> <span class="n">region</span> <span class="k">else</span> <span class="n">fallback_region</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">region</span> <span class="o">=</span> <span class="n">fallback_region</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">):</span>
                <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span>

            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">region</span></div>


<div class="viewcode-block" id="set_region"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.set_region.html#cloudknot.aws.set_region">[docs]</a><span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">set_region</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the AWS region that cloudknot will use</span>

<span class="sd">    Set region by modifying the cloudknot config file and clients</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    region : string</span>
<span class="sd">        An AWS region.</span>
<span class="sd">        Default: &#39;us-east-1&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_regions</span><span class="p">()</span>
    <span class="n">region_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;RegionName&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Regions&#39;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">region</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">region_names</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;`region` must be in </span><span class="si">{regions!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">regions</span><span class="o">=</span><span class="n">region_names</span>
        <span class="p">))</span>

    <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">):</span>  <span class="c1"># pragma: nocover</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Update the boto3 clients so that the region change is reflected</span>
        <span class="c1"># throughout the package</span>
        <span class="n">max_pool</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_pool_connections</span>
        <span class="n">boto_config</span> <span class="o">=</span> <span class="n">botocore</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="n">max_pool_connections</span><span class="o">=</span><span class="n">max_pool</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                          <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;cloudformation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;cloudformation&#39;</span><span class="p">,</span>
                                                   <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                                   <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ecr&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ecs&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;iam&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;sts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;sts&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                       <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_profiles"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.list_profiles.html#cloudknot.aws.list_profiles">[docs]</a><span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">list_profiles</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a list of available AWS profile names</span>

<span class="sd">    Search the aws credentials file and the aws config file for profile names</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    profile_names : namedtuple</span>
<span class="sd">        A named tuple with fields: `profile_names`, a list of AWS profiles in</span>
<span class="sd">        the aws config file and the aws shared credentials file;</span>
<span class="sd">        `credentials_file`, a path to the aws shared credentials file;</span>
<span class="sd">        and `aws_config_file`, a path to the aws config file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;.aws&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get aws credentials file from environment variable</span>
        <span class="n">env_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_SHARED_CREDENTIALS_FILE&#39;</span><span class="p">]</span>
        <span class="n">credentials_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">env_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># Fallback on default credentials file path</span>
        <span class="n">credentials_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="s1">&#39;credentials&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get aws config file from environment variable</span>
        <span class="n">env_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_CONFIG_FILE&#39;</span><span class="p">]</span>
        <span class="n">aws_config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">env_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># Fallback on default aws config file path</span>
        <span class="n">aws_config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aws</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>

    <span class="n">credentials</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">credentials</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">credentials_file</span><span class="p">)</span>

    <span class="n">aws_config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">aws_config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">aws_config_file</span><span class="p">)</span>

    <span class="n">profile_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">aws_config</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;profile&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">profile_names</span> <span class="o">+=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>

    <span class="c1"># define a namedtuple for return value type</span>
    <span class="n">ProfileInfo</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
        <span class="s1">&#39;ProfileInfo&#39;</span><span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;profile_names&#39;</span><span class="p">,</span> <span class="s1">&#39;credentials_file&#39;</span><span class="p">,</span> <span class="s1">&#39;aws_config_file&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ProfileInfo</span><span class="p">(</span>
        <span class="n">profile_names</span><span class="o">=</span><span class="n">profile_names</span><span class="p">,</span>
        <span class="n">credentials_file</span><span class="o">=</span><span class="n">credentials_file</span><span class="p">,</span>
        <span class="n">aws_config_file</span><span class="o">=</span><span class="n">aws_config_file</span>
    <span class="p">)</span></div>


<span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">get_user</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;sts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_caller_identity</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Arn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<div class="viewcode-block" id="get_profile"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.get_profile.html#cloudknot.aws.get_profile">[docs]</a><span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="s1">&#39;from-env&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the AWS profile to use</span>

<span class="sd">    First, check the cloudknot config file for the profile option.</span>
<span class="sd">    If that fails, check for the AWS_PROFILE environment variable.</span>
<span class="sd">    If that fails, return &#39;default&#39; if there is a default profile in AWS config</span>
<span class="sd">    or credentials files. If that fails, return the fallback value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fallback :</span>
<span class="sd">        The fallback value if get_profile cannot find an AWS profile.</span>
<span class="sd">        Default: &#39;from-env&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    profile_name : string</span>
<span class="sd">        An AWS profile listed in the aws config file or aws shared</span>
<span class="sd">        credentials file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set profile from environment variable</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_PROFILE&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">list_profiles</span><span class="p">()</span><span class="o">.</span><span class="n">profile_names</span><span class="p">:</span>
                    <span class="c1"># Set profile in cloudknot config to &#39;default&#39;</span>
                    <span class="n">profile</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">fallback</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">):</span>
                <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span>

            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">profile</span></div>


<div class="viewcode-block" id="set_profile"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.set_profile.html#cloudknot.aws.set_profile">[docs]</a><span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">set_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the AWS profile that cloudknot will use</span>

<span class="sd">    Set profile by modifying the cloudknot config file and clients</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile_name : string</span>
<span class="sd">        An AWS profile listed in the aws config file or aws shared</span>
<span class="sd">        credentials file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">profile_info</span> <span class="o">=</span> <span class="n">list_profiles</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">profile_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile_info</span><span class="o">.</span><span class="n">profile_names</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
            <span class="s1">&#39;The profile you specified does not exist in either the AWS &#39;</span>
            <span class="s1">&#39;config file at </span><span class="si">{conf:s}</span><span class="s1"> or the AWS shared credentials file at &#39;</span>
            <span class="s1">&#39;</span><span class="si">{cred:s}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">conf</span><span class="o">=</span><span class="n">profile_info</span><span class="o">.</span><span class="n">aws_config_file</span><span class="p">,</span>
                <span class="n">cred</span><span class="o">=</span><span class="n">profile_info</span><span class="o">.</span><span class="n">credentials_file</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">):</span>  <span class="c1"># pragma: nocover</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Update the boto3 clients so that the profile change is reflected</span>
        <span class="c1"># throughout the package</span>
        <span class="n">max_pool</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_pool_connections</span>
        <span class="n">boto_config</span> <span class="o">=</span> <span class="n">botocore</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="n">max_pool_connections</span><span class="o">=</span><span class="n">max_pool</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                          <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;cloudformation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;cloudformation&#39;</span><span class="p">,</span>
                                                   <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                                   <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ecr&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ecs&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;iam&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;sts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;sts&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                       <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span></div>


<span class="c1">#: module-level dictionary of boto3 clients for IAM, EC2, Batch, ECR, ECS, S3.</span>
<span class="n">clients</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;batch&#39;</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
        <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">()</span>
    <span class="p">),</span>
    <span class="s1">&#39;cloudformation&#39;</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span>
        <span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;cloudformation&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">()),</span>
    <span class="s1">&#39;ecr&#39;</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
        <span class="s1">&#39;ecr&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">()</span>
    <span class="p">),</span>
    <span class="s1">&#39;ecs&#39;</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
        <span class="s1">&#39;ecs&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">()</span>
    <span class="p">),</span>
    <span class="s1">&#39;ec2&#39;</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
        <span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">()</span>
    <span class="p">),</span>
    <span class="s1">&#39;iam&#39;</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
        <span class="s1">&#39;iam&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">()</span>
    <span class="p">),</span>
    <span class="s1">&#39;sts&#39;</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
        <span class="s1">&#39;sts&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">()</span>
    <span class="p">),</span>
    <span class="s1">&#39;s3&#39;</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
        <span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">()</span>
    <span class="p">),</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;module-level dictionary of boto3 clients.</span>

<span class="sd">Storing the boto3 clients in a module-level dictionary allows us to change</span>
<span class="sd">the region and profile and have those changes reflected globally.</span>

<span class="sd">Advanced users: if you want to use cloudknot and boto3 at the same time,</span>
<span class="sd">you should use these clients to ensure that you have the right profile</span>
<span class="sd">and region.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="refresh_clients"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.refresh_clients.html#cloudknot.aws.refresh_clients">[docs]</a><span class="nd">@registered</span>
<span class="k">def</span> <span class="nf">refresh_clients</span><span class="p">(</span><span class="n">max_pool</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Refresh the boto3 clients dictionary&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">botocore</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="n">max_pool_connections</span><span class="o">=</span><span class="n">max_pool</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;iam&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                          <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ecr&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ecs&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                       <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;cloudformation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;cloudformation&#39;</span><span class="p">,</span>
                                                   <span class="n">region_name</span><span class="o">=</span><span class="n">get_region</span><span class="p">(),</span>
                                                   <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="ResourceExistsException"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.ResourceExistsException.html#cloudknot.aws.ResourceExistsException">[docs]</a><span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">ResourceExistsException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception indicating that the requested AWS resource already exists&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : string</span>
<span class="sd">            The error message to display to the user</span>

<span class="sd">        resource_id : string</span>
<span class="sd">            The resource ID (e.g. ARN, VPC-ID) of the requested resource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResourceExistsException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">resource_id</span></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="ResourceDoesNotExistException"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.ResourceDoesNotExistException.html#cloudknot.aws.ResourceDoesNotExistException">[docs]</a><span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">ResourceDoesNotExistException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception indicating that the requested AWS resource does not exists&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : string</span>
<span class="sd">            The error message to display to the user</span>

<span class="sd">        resource_id : string</span>
<span class="sd">            The resource ID (e.g. ARN, VPC-ID) of the requested resource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResourceDoesNotExistException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">resource_id</span></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="ResourceClobberedException"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.ResourceClobberedException.html#cloudknot.aws.ResourceClobberedException">[docs]</a><span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">ResourceClobberedException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception indicating that this AWS resource has been clobbered&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : string</span>
<span class="sd">            The error message to display to the user</span>

<span class="sd">        resource_id : string</span>
<span class="sd">            The resource ID (e.g. ARN, VPC-ID) of the requested resource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResourceClobberedException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">resource_id</span></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="CannotDeleteResourceException"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.CannotDeleteResourceException.html#cloudknot.aws.CannotDeleteResourceException">[docs]</a><span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">CannotDeleteResourceException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception indicating that an AWS resource cannot be deleted&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : string</span>
<span class="sd">            The error message to display to the user</span>

<span class="sd">        resource_id : string</span>
<span class="sd">            The resource ID (e.g. ARN, VPC-ID) of the dependent resources</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CannotDeleteResourceException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">resource_id</span></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="CannotCreateResourceException"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.CannotCreateResourceException.html#cloudknot.aws.CannotCreateResourceException">[docs]</a><span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">CannotCreateResourceException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception indicating that an AWS resource cannot be created&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : string</span>
<span class="sd">            The error message to display to the user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CannotCreateResourceException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="RegionException"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.RegionException.html#cloudknot.aws.RegionException">[docs]</a><span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">RegionException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception indicating the current region is not this resource&#39;s region&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_region</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        resource_region : string</span>
<span class="sd">            The resource region</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegionException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;This resource&#39;s region (</span><span class="si">{resource:s}</span><span class="s2">) does not match the &quot;</span>
            <span class="s2">&quot;current region (</span><span class="si">{current:s}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">resource</span><span class="o">=</span><span class="n">resource_region</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">get_region</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_region</span> <span class="o">=</span> <span class="n">get_region</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_region</span> <span class="o">=</span> <span class="n">resource_region</span></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">ProfileException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception indicating the current profile isn&#39;t the resource&#39;s profile&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_profile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        resource_profile : string</span>
<span class="sd">            The resource profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProfileException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;This resource&#39;s profile (</span><span class="si">{resource:s}</span><span class="s2">) does not match the &quot;</span>
            <span class="s2">&quot;current profile (</span><span class="si">{current:s}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">resource</span><span class="o">=</span><span class="n">resource_profile</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">get_profile</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_profile</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_profile</span> <span class="o">=</span> <span class="n">resource_profile</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">CKTimeoutError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cloudknot timeout error for AWS Batch job results</span>

<span class="sd">    Error indicating an AWS Batch job failed to return results within</span>
<span class="sd">    the requested time period</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CKTimeoutError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s1">&#39;The job with job-id </span><span class="si">{jid:s}</span><span class="s1"> did not finish within the &#39;</span>
            <span class="s1">&#39;requested timeout period&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jid</span><span class="o">=</span><span class="n">job_id</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">BatchJobFailedError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error indicating an AWS Batch job failed&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_id : string</span>
<span class="sd">            The AWS jobId of the failed job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BatchJobFailedError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;AWS Batch job </span><span class="si">{job_id:s}</span><span class="s2"> has failed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">CloudknotConfigurationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error indicating an cloudknot has not been properly configured&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config_file : string</span>
<span class="sd">            The path to the cloudknot config file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudknotConfigurationError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;It looks like you haven&#39;t run `cloudknot configure` to set up &quot;</span>
            <span class="s2">&quot;your cloudknot environment. Or perhaps you did that but you have &quot;</span>
            <span class="s2">&quot;since deleted your cloudknot configuration file. Please run &quot;</span>
            <span class="s2">&quot;`cloudknot configure` before using cloudknot. &quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="n">config_file</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">CloudknotInputError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error indicating an input argument has an invalid value&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Exception</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg : string</span>
<span class="sd">            The error message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudknotInputError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<span class="nd">@registered</span>
<span class="k">class</span> <span class="nc">NamedObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for building objects with name property&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a base class with a name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : string</span>
<span class="sd">            Name of the object. Must satisfy regular expression</span>
<span class="sd">            pattern: [a-zA-Z][-a-zA-Z0-9]*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">conf</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;configured&#39;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;configured&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotConfigurationError</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[a-zA-Z][-a-zA-Z0-9]*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;name must satisfy regular expression &#39;</span>
                                      <span class="s1">&#39;pattern: [a-zA-Z][-a-zA-Z0-9]*&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_region</span> <span class="o">=</span> <span class="n">get_region</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The name of this AWS resource&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">clobbered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Has this instance been previously clobbered&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">region</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The AWS region in which this resource was created&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_region</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The AWS profile in which this resource was created&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span>

    <span class="k">def</span> <span class="nf">_get_section_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the config section name</span>

<span class="sd">        Append profile and region to the resource type name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">resource_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">check_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for profile exception&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">!=</span> <span class="n">get_profile</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ProfileException</span><span class="p">(</span><span class="n">resource_profile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_profile_and_region</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for region and profile exceptions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">!=</span> <span class="n">get_region</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">RegionException</span><span class="p">(</span><span class="n">resource_region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    
    <div class="footer">
      &copy;2017, Adam Richie-Halford, Ariel Rokem.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
    <script type="text/javascript">
        $(document).ready(function() {
            $(".toggle > *").hide();
            $(".toggle .header").show();
            $(".toggle .header").click(function() {
                $(this).parent().children().not(".header").toggle(400);
                $(this).parent().children(".header").toggleClass("open");
            })
        });
    </script>

  </body>
</html>