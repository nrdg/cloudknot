
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cloudknot.dockerimage &#8212; cloudknot 0.5.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/collapsible.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">cloudknot</a></h1>



<p class="blurb">Run your existing python code on AWS Batch</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=nrdg&repo=cloudknot&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation.html">documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">faq</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/nrdg/cloudknot/tree/master/examples">examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/nrdg/cloudknot">code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/nrdg/cloudknot/issues">bugs</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cloudknot.dockerimage</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Create, build, push, and manage Docker images for use in Cloudknot.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">docker</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pipreqs</span> <span class="kn">import</span> <span class="n">pipreqs</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">aws</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">ckconfig</span>
<span class="kn">from</span> <span class="nn">.aws.base_classes</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_region</span><span class="p">,</span>
    <span class="n">get_profile</span><span class="p">,</span>
    <span class="n">ResourceClobberedException</span><span class="p">,</span>
    <span class="n">CloudknotInputError</span><span class="p">,</span>
    <span class="n">CloudknotConfigurationError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">get_config_file</span><span class="p">,</span> <span class="n">rlock</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DockerImage&quot;</span><span class="p">]</span>


<span class="n">mod_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">is_windows</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="DockerImage"><a class="viewcode-back" href="../../documentation.html#cloudknot.DockerImage">[docs]</a><span class="k">class</span> <span class="nc">DockerImage</span><span class="p">(</span><span class="n">aws</span><span class="o">.</span><span class="n">NamedObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for dockerizing a python script or function.</span>

<span class="sd">    If given a python function, DockerImage will create a CLI</span>
<span class="sd">    version for that function, write a requirements.txt file for all import</span>
<span class="sd">    statements in the function, and write a Dockerfile to containerize that</span>
<span class="sd">    python script. If given a path to a python script, DockerImage will assume</span>
<span class="sd">    it has a CLI and will skip the first step, building a requirements.txt file</span>
<span class="sd">    and a Dockerfile as before.</span>

<span class="sd">    If the input script or function contains imports that cannot be identified</span>
<span class="sd">    by pipreqs (i.e. cannot be installed with `pip install package`, those</span>
<span class="sd">    packages will not be included in requirements.txt, DockerImage will throw</span>
<span class="sd">    a warning, and the user must install those packages by hand in the</span>
<span class="sd">    Dockerfile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of DockerImage, only used to retrieve DockerImage from</span>
<span class="sd">        config file info. Do not use to create new DockerImage.</span>
<span class="sd">        Must satisfy regular expression pattern: [a-zA-Z][-a-zA-Z0-9]*</span>

<span class="sd">    func : function</span>
<span class="sd">        Python function to be dockerized</span>

<span class="sd">    script_path : string</span>
<span class="sd">        Path to file with python script to be dockerized</span>

<span class="sd">    dir_name : string</span>
<span class="sd">        Directory to store Dockerfile, requirements.txt, and python</span>
<span class="sd">        script with CLI</span>
<span class="sd">        Default: parent directory of script if `script_path` is provided</span>
<span class="sd">        else DockerImage creates a new directory, accessible by the</span>
<span class="sd">        `build_path` property.</span>

<span class="sd">    base_image : string</span>
<span class="sd">        Docker base image on which to base this Dockerfile</span>
<span class="sd">        Default: None will use the python base image for the</span>
<span class="sd">        current version of python</span>

<span class="sd">    github_installs : string or sequence of strings</span>
<span class="sd">        Github addresses for packages to install from github rather than</span>
<span class="sd">        PyPI (e.g. git://github.com/nrdg/cloudknot.git or</span>
<span class="sd">        git://github.com/nrdg/cloudknot.git@newfeaturebranch)</span>
<span class="sd">        Default: ()</span>

<span class="sd">    username : string</span>
<span class="sd">        Default user created in the Dockerfile</span>
<span class="sd">        Default: &#39;cloudknot-user&#39;</span>

<span class="sd">    overwrite : bool, default=False</span>
<span class="sd">        If True, allow overwriting any existing Dockerfiles,</span>
<span class="sd">        requirements files, or python scripts previously created by</span>
<span class="sd">        cloudknot</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">script_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dir_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">base_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">github_installs</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a DockerImage instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of DockerImage, only used to save/retrieve DockerImage from</span>
<span class="sd">            config file info.</span>
<span class="sd">            Must satisfy regular expression pattern: [a-zA-Z][-a-zA-Z0-9]*</span>

<span class="sd">        func : function</span>
<span class="sd">            Python function to be dockerized</span>

<span class="sd">        script_path : string</span>
<span class="sd">            Path to file with python script to be dockerized</span>

<span class="sd">        dir_name : string</span>
<span class="sd">            Directory to store Dockerfile, requirements.txt, and python</span>
<span class="sd">            script with CLI</span>
<span class="sd">            Default: parent directory of script if `script_path` is provided</span>
<span class="sd">            else DockerImage creates a new directory, accessible by the</span>
<span class="sd">            `build_path` property.</span>

<span class="sd">        base_image : string</span>
<span class="sd">            Docker base image on which to base this Dockerfile</span>
<span class="sd">            Default: None will use the python base image for the</span>
<span class="sd">            current version of python</span>

<span class="sd">        github_installs : string or sequence of strings</span>
<span class="sd">            Github addresses for packages to install from github rather than</span>
<span class="sd">            PyPI (e.g. git://github.com/nrdg/cloudknot.git or</span>
<span class="sd">            git://github.com/nrdg/cloudknot.git@newfeaturebranch)</span>
<span class="sd">            Default: ()</span>

<span class="sd">        username : string</span>
<span class="sd">            Default user created in the Dockerfile</span>
<span class="sd">            Default: &#39;cloudknot-user&#39;</span>

<span class="sd">        overwrite : bool, default=False</span>
<span class="sd">            If True, allow overwriting any existing Dockerfiles,</span>
<span class="sd">            requirements files, or python scripts previously created by</span>
<span class="sd">            cloudknot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># User must specify at least `name`, `func`, or `script_path`</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">script_path</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s2">&quot;You must suppy either `name`, `func` &quot;</span> <span class="s2">&quot;or `script_path`.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If `func` and `script_path` are specified, input is over-specified</span>
        <span class="k">if</span> <span class="n">script_path</span> <span class="ow">and</span> <span class="n">func</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s2">&quot;You provided redundant and possibly conflicting arguments &quot;</span>
                <span class="s2">&quot;`script_path` and `func`. Please provide only one of those.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Default booleans to be potentially changed in if blocks below</span>
        <span class="n">params_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">clobber_script</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="c1"># Validate name input</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                    <span class="s2">&quot;Docker image name must be a &quot;</span>
                    <span class="s2">&quot;string. You passed a </span><span class="si">{t!s}</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="p">)</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">DockerImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="n">section_name</span> <span class="o">=</span> <span class="s2">&quot;docker-image &quot;</span> <span class="o">+</span> <span class="n">name</span>

            <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">section_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
                <span class="n">params_changed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_region</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;profile&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">function_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;function-hash&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;build-path&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;script-path&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_docker_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;docker-path&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_req_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;req-path&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;base-image&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;github-imports&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;clobber-script&quot;</span><span class="p">)</span>

                <span class="n">images_str</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>
                <span class="n">images_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">images_str</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_images</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images_list</span><span class="p">]</span>

                <span class="n">uri</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;repo-uri&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="n">uri</span> <span class="k">if</span> <span class="n">uri</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">uri</span><span class="p">:</span>
                    <span class="n">repo_info</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">ecr</span><span class="o">.</span><span class="n">_get_repo_info_from_uri</span><span class="p">(</span><span class="n">repo_uri</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_repo_registry_id</span> <span class="o">=</span> <span class="n">repo_info</span><span class="p">[</span><span class="s2">&quot;registry_id&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_repo_name</span> <span class="o">=</span> <span class="n">repo_info</span><span class="p">[</span><span class="s2">&quot;repo_name&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_repo_registry_id</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_repo_name</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Set self.pip_imports and self.missing_imports</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_imports</span><span class="p">()</span>

                <span class="c1"># Do not allow script_path or dir_name for pre-existing images</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">script_path</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                        <span class="s2">&quot;You specified a name plus either a script_path or &quot;</span>
                        <span class="s2">&quot;directory_name. The name parameter is used to retrieve a &quot;</span>
                        <span class="s2">&quot;pre-existing DockerImage instance. You may retrieve a &quot;</span>
                        <span class="s2">&quot;pre-existing and change the `func`, `username`, `base_image`, &quot;</span>
                        <span class="s2">&quot;and `github_installs` parameters, but not the `script_path` or &quot;</span>
                        <span class="s2">&quot;`dir_name`. Please either remove those parameters or create a new &quot;</span>
                        <span class="s2">&quot;DockerImage with a different name.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Check for consistency of remaining redundant input</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">func</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">base_image</span><span class="p">,</span> <span class="n">github_installs</span><span class="p">]):</span>
                    <span class="n">input_params</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;func&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">function_hash</span><span class="p">),</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">),</span>
                        <span class="s2">&quot;base_image&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">base_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span><span class="p">),</span>
                        <span class="s2">&quot;github_installs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">github_installs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span><span class="p">),</span>
                    <span class="p">}</span>

                    <span class="n">conflicting_params</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="n">conflicting_params</span><span class="p">:</span>
                        <span class="c1"># Set flag to do all the setup stuff below, warn user</span>
                        <span class="n">params_changed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Found </span><span class="si">{name:s}</span><span class="s2"> in your config file but the input parameters &quot;</span>
                            <span class="s2">&quot;have changed. The updated parameters are </span><span class="si">{l}</span><span class="s2">. Continuing &quot;</span>
                            <span class="s2">&quot;with the new input parameters and disregarding any old, &quot;</span>
                            <span class="s2">&quot;potentially conflicting ones.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">section_name</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">conflicting_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                        <span class="c1"># Use input params if provided, fall back on config values</span>
                        <span class="n">username</span> <span class="o">=</span> <span class="n">username</span> <span class="k">if</span> <span class="n">username</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span>
                        <span class="n">base_image</span> <span class="o">=</span> <span class="n">base_image</span> <span class="k">if</span> <span class="n">base_image</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span>
                        <span class="n">github_installs</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">github_installs</span>
                            <span class="k">if</span> <span class="n">github_installs</span>
                            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span>
                        <span class="p">)</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="n">func</span> <span class="k">if</span> <span class="n">func</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span>
                        <span class="n">script_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span>
                        <span class="n">dir_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span>
                        <span class="n">clobber_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">params_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">username</span> <span class="k">if</span> <span class="n">username</span> <span class="k">else</span> <span class="s2">&quot;cloudknot-user&quot;</span>

            <span class="k">if</span> <span class="n">base_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span> <span class="o">=</span> <span class="n">base_image</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">py_ver</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span> <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span> <span class="k">else</span> <span class="s2">&quot;2&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span> <span class="o">=</span> <span class="s2">&quot;python:&quot;</span> <span class="o">+</span> <span class="n">py_ver</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;python:3&quot;</span><span class="p">,</span> <span class="s2">&quot;python:3.8&quot;</span><span class="p">]:</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Warning, your Dockerfile will have a base image of python:3, &quot;</span>
                    <span class="s2">&quot;which may default to Python 3.8. This may cause dependency &quot;</span>
                    <span class="s2">&quot;conflicts. If this build fails, consider rerunning with the &quot;</span>
                    <span class="s2">&quot;`base_image=&#39;python:3.7&#39; parameter.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Validate dir_name input</span>
            <span class="k">if</span> <span class="n">dir_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s2">&quot;`dir_name` is not an existing &quot;</span> <span class="s2">&quot;directory&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">script_path</span><span class="p">:</span>
                <span class="c1"># User supplied a pre-existing python script.</span>
                <span class="c1"># Ensure we don&#39;t clobber it later</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span> <span class="o">=</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">clobber_script</span>

                <span class="c1"># Check that it is a valid path</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                        <span class="s2">&quot;If provided, `script_path` must be an existing &quot;</span>
                        <span class="s2">&quot;regular file.&quot;</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">script_path</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">DockerImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">name</span>
                    <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Set the parent directory</span>
                <span class="k">if</span> <span class="n">dir_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_script</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We will create the script, Dockerfile, and requirements.txt</span>
                <span class="c1"># in a new directory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">DockerImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">dir_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.py&quot;</span><span class="p">)</span>

                    <span class="c1"># Confirm that we will not overwrite an existing script</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                            <span class="s2">&quot;There is a pre-existing python script in the &quot;</span>
                            <span class="s2">&quot;directory that you provided. Either specify a &quot;</span>
                            <span class="s2">&quot;new directory, move the python script `</span><span class="si">{file:s}</span><span class="s2">` &quot;</span>
                            <span class="s2">&quot;to a new directory, or delete the existing &quot;</span>
                            <span class="s2">&quot;python script if it is no longer &quot;</span>
                            <span class="s2">&quot;necessary.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Create a new unique directory name</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;cloudknot_docker_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

                    <span class="c1"># Store the script in the new directory</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.py&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_write_script</span><span class="p">()</span>

            <span class="c1"># Create the Dockerfile and requirements.txt in the parent dir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_docker_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span> <span class="s2">&quot;Dockerfile&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_req_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span> <span class="s2">&quot;requirements.txt&quot;</span><span class="p">)</span>

            <span class="c1"># Confirm that we won&#39;t overwrite an existing Dockerfile</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_docker_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                    <span class="s2">&quot;There is a pre-existing Dockerfile in the same directory &quot;</span>
                    <span class="s2">&quot;as the python script you provided or in the directory &quot;</span>
                    <span class="s2">&quot;name that you provided. Either specify a new directory, &quot;</span>
                    <span class="s2">&quot;move the Dockerfile `</span><span class="si">{file:s}</span><span class="s2">` to a new directory, or &quot;</span>
                    <span class="s2">&quot;delete the existing Dockerfile if it is no longer &quot;</span>
                    <span class="s2">&quot;necessary.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Confirm that we won&#39;t overwrite an existing requirements.txt</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_req_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                    <span class="s2">&quot;There is a pre-existing requirements.txt in the same &quot;</span>
                    <span class="s2">&quot;directory as the python script you provided or in the &quot;</span>
                    <span class="s2">&quot;directory name that you provided. Either specify a new &quot;</span>
                    <span class="s2">&quot;directory, move the requirements file`</span><span class="si">{file:s}</span><span class="s2">` to its &quot;</span>
                    <span class="s2">&quot;own directory or delete the existing requirements file &quot;</span>
                    <span class="s2">&quot;if it is no longer needed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Validate github installs before building Dockerfile</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">github_installs</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span> <span class="o">=</span> <span class="p">[</span><span class="n">github_installs</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">github_installs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">github_installs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                    <span class="s2">&quot;github_installs must be a string &quot;</span> <span class="s2">&quot;or a sequence of strings.&quot;</span>
                <span class="p">)</span>

            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(https|git)(://github.com/).*/.*\.git($|@.*$|#egg=.*$)&quot;</span>
            <span class="k">for</span> <span class="n">install</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span><span class="p">:</span>
                <span class="n">match_obj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">install</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                        <span class="s2">&quot;One of your github_installs, </span><span class="si">{i:s}</span><span class="s2"> is not formatted &quot;</span>
                        <span class="s2">&quot;correctly. It should look something like &quot;</span>
                        <span class="s2">&quot;git://github.com/user/repo.git, &quot;</span>
                        <span class="s2">&quot;git://github.com/user/repo.git@branch, &quot;</span>
                        <span class="s2">&quot;git://github.com/user/repo.git#egg=project[extra], &quot;</span>
                        <span class="s2">&quot;https://github.com/user/repo.git, &quot;</span>
                        <span class="s2">&quot;https://github.com/user/repo.git@branch, or&quot;</span>
                        <span class="s2">&quot;https://github.com/user/repo.git#egg=project[extra]. &quot;</span>
                        <span class="s2">&quot;See https://pip.pypa.io/en/stable/reference/pip_install/#git &quot;</span>
                        <span class="s2">&quot;for more info.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Set self.pip_imports and self.missing_imports</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_imports</span><span class="p">()</span>

            <span class="c1"># Write the requirements.txt file and Dockerfile</span>
            <span class="n">pipreqs</span><span class="o">.</span><span class="n">generate_requirements_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pip_imports</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_write_dockerfile</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_images</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_registry_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Add to config file</span>
            <span class="n">section_name</span> <span class="o">=</span> <span class="s2">&quot;docker-image &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;function-hash&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">)))</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;build-path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;script-path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;docker-path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;req-path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;base-image&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_image</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;github-imports&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">github_installs</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;repo-uri&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;clobber-script&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Declare read-only properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Python function that was dockerized.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">build_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return build path for the docker image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">script_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path to the CLI version of the python function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">docker_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path to the generated Dockerfile.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">req_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path to the generated requirements.txt file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_req_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pip_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of packages in the requirements.txt file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pip_imports</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Docker base image on which to base the docker image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">github_installs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List packages installed from github rather than PyPI.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return default username created in Dockerfile.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">missing_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List required imports that are unavailable through pip install.</span>

<span class="sd">        The user must edit the Dockerfile by hand to install these packages</span>
<span class="sd">        before using the build or push methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_missing_imports</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List name, tag dicts for docker images built by this instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_images</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repo_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Location of remote repository to which the image was pushed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repo_registry_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Registry ID of remote repository to which the image was pushed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repo_registry_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repo_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Name of remote repository to which the image was pushed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repo_name</span>

    <span class="k">def</span> <span class="nf">_write_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write this instance&#39;s function to a script with a CLI.</span>

<span class="sd">        Use the template file to insert the self.func source code and name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;templates&quot;</span><span class="p">,</span> <span class="s2">&quot;script.template&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">template</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
                        <span class="n">func_source</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">),</span>
                        <span class="n">func_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Wrote python function </span><span class="si">{func:s}</span><span class="s2"> to script </span><span class="si">{script:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_dockerfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write Dockerfile to containerize this instance&#39;s python function.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;templates&quot;</span><span class="p">,</span> <span class="s2">&quot;Dockerfile.template&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_installs</span><span class="p">:</span>
                <span class="n">github_installs_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot; </span><span class="se">\\\n</span><span class="s2">    &amp;&amp; pip install --no-cache-dir git+&quot;</span> <span class="o">+</span> <span class="n">install</span>
                        <span class="k">for</span> <span class="n">install</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_installs</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">github_installs_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">template</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
                        <span class="n">app_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="n">base_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_image</span><span class="p">,</span>
                        <span class="n">script_base_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">),</span>
                        <span class="n">github_installs_string</span><span class="o">=</span><span class="n">github_installs_string</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wrote Dockerfile </span><span class="si">{path:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_set_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set required imports for the python script at self.script_path.&quot;&quot;&quot;</span>
        <span class="c1"># Get the names of packages imported in the script</span>
        <span class="n">import_names</span> <span class="o">=</span> <span class="n">pipreqs</span><span class="o">.</span><span class="n">get_all_imports</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">))</span>

        <span class="c1"># Of those names, store that ones that are available via pip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pip_imports</span> <span class="o">=</span> <span class="n">pipreqs</span><span class="o">.</span><span class="n">get_imports_info</span><span class="p">(</span><span class="n">import_names</span><span class="p">)</span>

        <span class="c1"># If some imports were left out, store their names</span>
        <span class="n">pip_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pip_imports</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_missing_imports</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">import_names</span><span class="p">)</span> <span class="o">-</span> <span class="n">pip_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">import_names</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pip_imports</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">github_installs</span><span class="p">)):</span>
            <span class="c1"># And warn the user</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Warning, some imports not found by pipreqs. You will &quot;</span>
                <span class="s2">&quot;need to edit the Dockerfile by hand, e.g by installing &quot;</span>
                <span class="s2">&quot;from github. You need to install the following packages &quot;</span>
                <span class="s2">&quot;</span><span class="si">{missing!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_imports</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">image_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a Docker image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tags : str or sequence of str</span>
<span class="sd">            Tags to be applied to this Docker image</span>

<span class="sd">        image_name : str</span>
<span class="sd">            Name of Docker image to be built</span>
<span class="sd">            Default: &#39;cloudknot/&#39; + self.name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s2">&quot;This docker image has already been clobbered.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="c1"># Validate tags input</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tags</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s2">&quot;tags must be a string or a sequence &quot;</span> <span class="s2">&quot;of strings.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Don&#39;t allow user to put &quot;latest&quot; in tags.</span>
        <span class="k">if</span> <span class="s2">&quot;latest&quot;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s2">&quot;Any tag is allowed, except for &quot;</span> <span class="s1">&#39;&quot;latest.&quot;&#39;</span><span class="p">)</span>

        <span class="n">image_name</span> <span class="o">=</span> <span class="n">image_name</span> <span class="k">if</span> <span class="n">image_name</span> <span class="k">else</span> <span class="s2">&quot;cloudknot/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">images</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">image_name</span><span class="p">,</span> <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_images</span> <span class="o">+=</span> <span class="p">[</span><span class="n">im</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">images</span> <span class="k">if</span> <span class="n">im</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">]</span>

        <span class="c1"># Use docker low-level APIClient</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Building image </span><span class="si">{name:s}</span><span class="s2"> with tag </span><span class="si">{tag:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">c</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span>
                <span class="n">dockerfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">,</span>
                <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Update the config file images list</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="c1"># Get list of images in config file</span>
        <span class="n">section_name</span> <span class="o">=</span> <span class="s2">&quot;docker-image &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">config_images_str</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>

        <span class="c1"># Split config images into list</span>
        <span class="n">config_images_list</span> <span class="o">=</span> <span class="n">config_images_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1"># Convert images just build into list</span>
        <span class="n">current_images_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

        <span class="c1"># Get the union of the two lists</span>
        <span class="n">config_images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">config_images_list</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_images_list</span><span class="p">))</span>

        <span class="c1"># Convert back to space separated list string</span>
        <span class="n">config_images_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_images</span><span class="p">)</span>

        <span class="c1"># Reload to config file</span>
        <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="n">config_images_str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repo_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tag and push a Docker image to a repository.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        repo : DockerRepo, optional</span>
<span class="sd">            DockerRepo instance to which to push this image</span>

<span class="sd">        repo_uri : string, optional</span>
<span class="sd">            URI for the docker repository to which to push this instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s2">&quot;This docker image has already been clobbered.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="c1"># User must supply either a repo object or the repo name and uri</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">repo</span> <span class="ow">or</span> <span class="n">repo_uri</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s2">&quot;You must supply either `repo=&quot;</span> <span class="s2">&quot;&lt;DockerRepo instance&gt;` or `repo_uri`.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># User cannot supply both repo and repo_name or repo_uri</span>
        <span class="k">if</span> <span class="n">repo</span> <span class="ow">and</span> <span class="n">repo_uri</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s2">&quot;You may not specify both a repo object &quot;</span> <span class="s2">&quot;and `repo_uri`.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Make sure that the user has called build first or somehow set tags.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s2">&quot;The images property is empty, indicating that the build &quot;</span>
                <span class="s2">&quot;method has not yet been called. Call `build(tags=&lt;tags&gt;)` &quot;</span>
                <span class="s2">&quot;first before calling `tag()`.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">aws</span><span class="o">.</span><span class="n">DockerRepo</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s2">&quot;repo must be of type DockerRepo.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">repo_uri</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_registry_id</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">repo_registry_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_name</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repo_uri</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s2">&quot;`repo_uri` must be a string.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="n">repo_uri</span>
            <span class="n">repo_info</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">ecr</span><span class="o">.</span><span class="n">_get_repo_info_from_uri</span><span class="p">(</span><span class="n">repo_uri</span><span class="o">=</span><span class="n">repo_uri</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_registry_id</span> <span class="o">=</span> <span class="n">repo_info</span><span class="p">[</span><span class="s2">&quot;registry_id&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_name</span> <span class="o">=</span> <span class="n">repo_info</span><span class="p">[</span><span class="s2">&quot;repo_name&quot;</span><span class="p">]</span>

        <span class="n">fallback</span> <span class="o">=</span> <span class="s2">&quot;from_env&quot;</span>
        <span class="k">if</span> <span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="n">fallback</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fallback</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;aws&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ecr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;get-login&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--no-include-email&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--region&quot;</span><span class="p">,</span>
                <span class="n">get_region</span><span class="p">(),</span>
                <span class="s2">&quot;--profile&quot;</span><span class="p">,</span>
                <span class="n">get_profile</span><span class="p">(),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;aws&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ecr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;get-login&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--no-include-email&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--region&quot;</span><span class="p">,</span>
                <span class="n">get_region</span><span class="p">(),</span>
            <span class="p">]</span>

        <span class="c1"># Determine if we&#39;re running in moto for CI</span>
        <span class="c1"># by retrieving the account ID</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="s2">&quot;iam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_user</span><span class="p">()[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span>
        <span class="n">account_id</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;Arn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">account_id</span> <span class="o">==</span> <span class="s2">&quot;123456789012&quot;</span><span class="p">:</span>
            <span class="c1"># Then we are mocking using moto. Use the ecr.put_image()</span>
            <span class="c1"># function instead of the Docker CLI to tag, push, etc.</span>
            <span class="c1"># This is the manifest for one of the hello-world versions</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="p">,</span>
                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">525</span><span class="p">,</span>
                <span class="s2">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:90659bf80b44ce6be8234e6ff90a1ac34acbeb826903b02cfa0da11c82cbc042&quot;</span><span class="p">,</span>
                <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;architecture&quot;</span><span class="p">:</span> <span class="s2">&quot;amd64&quot;</span><span class="p">,</span> <span class="s2">&quot;os&quot;</span><span class="p">:</span> <span class="s2">&quot;linux&quot;</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="c1"># Log tagging info</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Tagging image </span><span class="si">{name:s}</span><span class="s2"> with tag </span><span class="si">{tag:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># Log push info</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Pushing image </span><span class="si">{name:s}</span><span class="s2"> with tag </span><span class="si">{tag:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">aws</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="s2">&quot;ecr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">put_image</span><span class="p">(</span>
                    <span class="n">registryId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_repo_registry_id</span><span class="p">,</span>
                    <span class="n">repositoryName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_repo_name</span><span class="p">,</span>
                    <span class="n">imageManifest</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">manifest</span><span class="p">),</span>
                    <span class="n">imageTag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Then we&#39;re actually doing this thing. Use the Docker CLI</span>
            <span class="c1"># Refresh the aws ecr login credentials</span>
            <span class="n">login_cmd</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="n">is_windows</span><span class="p">)</span>

            <span class="c1"># Login</span>
            <span class="n">login_cmd_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">login_cmd</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ASCII&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">login_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">login_cmd_list</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
            <span class="p">)</span>

            <span class="c1"># If login failed, pass error to user</span>
            <span class="k">if</span> <span class="n">login_result</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                <span class="k">raise</span> <span class="n">CloudknotConfigurationError</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to login to AWS ECR using the command:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{login:s}</span><span class="se">\n</span><span class="s2">Returned exit code = </span><span class="si">{code}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;STDOUT: </span><span class="si">{out:s}</span><span class="se">\n</span><span class="s2">STDERR: </span><span class="si">{err:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">login</span><span class="o">=</span><span class="n">login_cmd</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                        <span class="n">code</span><span class="o">=</span><span class="n">login_result</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
                        <span class="n">out</span><span class="o">=</span><span class="n">login_result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                        <span class="n">err</span><span class="o">=</span><span class="n">login_result</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Use docker low-level APIClient for tagging</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span><span class="o">.</span><span class="n">api</span>
            <span class="c1"># And the image client for pushing</span>
            <span class="n">cli</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span><span class="o">.</span><span class="n">images</span>
            <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="c1"># Log tagging info</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Tagging image </span><span class="si">{name:s}</span><span class="s2"> with tag </span><span class="si">{tag:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Tag it with the most recently added image_name</span>
                <span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span>
                    <span class="n">image</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
                    <span class="n">repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">,</span>
                    <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="c1"># Log push info</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Pushing image </span><span class="si">{name:s}</span><span class="s2"> with tag </span><span class="si">{tag:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cli</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                    <span class="n">repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">):</span>
                    <span class="n">mod_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span>

            <span class="n">section_name</span> <span class="o">=</span> <span class="s2">&quot;docker-image &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s2">&quot;repo-uri&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all of the files associated with this instance.</span>

<span class="sd">        Always delete the generated requirements.txt and Dockerfile. Only</span>
<span class="sd">        delete the script if it was auto-generated. Only delete the parent</span>
<span class="sd">        directory if it is empty. Also delete the local docker image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">{path:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">))</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">)</span>
        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">{path:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">)</span>
        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">{path:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">{path:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># Directory is not empty. There&#39;s pre-existing stuff in there</span>
            <span class="c1"># that we shouldn&#39;t mess with.</span>
            <span class="k">pass</span>

        <span class="n">cli</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span><span class="o">.</span><span class="n">images</span>
        <span class="c1"># Get local images first (lol stands for list_of_lists)</span>
        <span class="n">local_image_lol</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">tags</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">cli</span><span class="o">.</span><span class="n">list</span><span class="p">()]</span>
        <span class="c1"># Flatten the list of lists</span>
        <span class="n">local_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">local_image_lol</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

        <span class="c1"># Use docker image client to remove local images</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">im</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">local_images</span><span class="p">:</span>
                <span class="c1"># Remove the local docker image, using the image name</span>
                <span class="n">cli</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span>
                    <span class="n">image</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">im</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">noprune</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="c1"># Update local_images to prevent redundant image removal</span>
                <span class="n">local_image_lol</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">tags</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">cli</span><span class="o">.</span><span class="n">list</span><span class="p">()]</span>
                <span class="n">local_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">local_image_lol</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">:</span>
            <span class="c1"># Determine if we&#39;re running in moto for CI</span>
            <span class="c1"># by retrieving the account ID</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="s2">&quot;iam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_user</span><span class="p">()[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span>
            <span class="n">account_id</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;Arn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">account_id</span> <span class="o">!=</span> <span class="s2">&quot;123456789012&quot;</span><span class="p">:</span>
                <span class="c1"># Then we&#39;re actually doing this thing. Use the Docker CLI</span>
                <span class="n">cli</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">noprune</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Remove from the config file</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">remove_section</span><span class="p">(</span><span class="s2">&quot;docker-image &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Removed local docker images &quot;</span> <span class="s2">&quot;</span><span class="si">{images!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
        <span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    
    <div class="footer">
      &copy;2017, Adam Richie-Halford, Ariel Rokem.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
    <script type="text/javascript">
        $(document).ready(function() {
            $(".toggle > *").hide();
            $(".toggle .header").show();
            $(".toggle .header").click(function() {
                $(this).parent().children().not(".header").toggle(400);
                $(this).parent().children(".header").toggleClass("open");
            })
        });
    </script>

  </body>
</html>